<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>
    <style>
        body { font-family: Arial, sans-serif; }
        .user-container { margin: 10px; padding: 10px; border: 1px solid #ccc; }
        .user-field { margin: 5px 0; }
        button { margin: 5px 0; }
        #authContainer { display: none; }
    </style>
</head>
<body>
    <div id="authContainer">
        <h1>Admin Login</h1>
        <form id="loginForm" onsubmit="authenticate(); return false;">
            <input type="text" id="username" placeholder="Username" required />
            <input type="password" id="password" placeholder="Password" required />
            <button type="submit">Login</button>
        </form>
    </div>

    <div id="dashboard" style="display: none;">
        <h1>Admin Dashboard</h1>
        <input type="text" id="searchBar" placeholder="Search by username or ID" onkeyup="searchUsers()" />
        <button onclick="fetchUsers()">Refresh Users</button>
        <div id="userList"></div>
    </div>

    <script>
        let allUsers = []; // Store the full list of users

        // Function to authenticate user
        async function authenticate() {
            const username = document.getElementById("username").value;
            const password = document.getElementById("password").value;

            // Make an authentication request to the backend
            const response = await fetch("https://telegram-bot-degen-town.replit.app/admin/users", {
                headers: {
                    "Authorization": "Basic " + btoa(username + ":" + password)
                }
            });

            if (response.ok) {
                document.getElementById("authContainer").style.display = "none";
                document.getElementById("dashboard").style.display = "block";
                fetchUsers(); // Fetch users after successful login
            } else {
                alert("Invalid username or password");
            }
        }

        // Fetch users from backend
        async function fetchUsers() {
            const response = await fetch("https://telegram-bot-degen-town.replit.app/admin/users", {
                headers: {
                    "Authorization": "Basic " + btoa(document.getElementById("username").value + ":" + document.getElementById("password").value)
                }
            });
            allUsers = await response.json();
            renderUsers(allUsers);
        }

        // Render users based on search results
        function renderUsers(users) {
            const userList = document.getElementById("userList");
            userList.innerHTML = ""; // Clear existing user elements

            users.forEach(user => {
                const userContainer = document.createElement("div");
                userContainer.classList.add("user-container");

                userContainer.innerHTML = `
                    <div class="user-field">User ID: ${user.userId}</div>
                    <div class="user-field">Username: ${user.username}</div>
                    <div class="user-field">Total Referrals: 
                        <input type="number" value="${user.totalReferrals}" id="totalReferrals-${user.userId}" readonly />
                    </div>
                    <div class="user-field">Withdraw Address: 
                        <input type="text" value="${user.withdrawAddress}" id="withdrawAddress-${user.userId}" />
                    </div>
                    <div class="user-field">Total Deposits: 
                        <input type="number" value="${user.totalDeposit}" id="totalDeposit-${user.userId}" readonly />
                    </div>
                    <div class="user-field">Commission Earned: 
                        <input type="number" value="${user.commissionEarned}" id="commissionEarned-${user.userId}" />
                    </div>
                    <div class="user-field">Commission Paid: 
                        <input type="number" value="${user.commissionPaid}" id="commissionPaid-${user.userId}" />
                    </div>
                    <button onclick="updateUser('${user.userId}')">Update User</button>
                `;
                userList.appendChild(userContainer);
            });
        }

        // Filter users based on search query
        function searchUsers() {
            const query = document.getElementById("searchBar").value.toLowerCase();
            const filteredUsers = allUsers.filter(user => 
                user.username.toLowerCase().includes(query) || user.userId.includes(query)
            );
            renderUsers(filteredUsers);
        }

        // Update user information
        async function updateUser(userId) {
            const withdrawAddress = document.getElementById(`withdrawAddress-${userId}`).value;
            const commissionEarned = document.getElementById(`commissionEarned-${userId}`).value;
            const commissionPaid = document.getElementById(`commissionPaid-${userId}`).value;

            const response = await fetch(`https://telegram-bot-degen-town.replit.app/admin/users/${userId}`, {
                method: "PUT",
                headers: {
                    "Content-Type": "application/json",
                    "Authorization": "Basic " + btoa(document.getElementById("username").value + ":" + document.getElementById("password").value)
                },
                body: JSON.stringify({
                    withdrawAddress,
                    commissionEarned, 
                    commissionPaid 
                })
            });

            if (response.ok) {
                alert("User updated successfully!");
                fetchUsers(); // Refresh the list
            } else {
                alert("Failed to update user.");
            }
        }
    </script>
</body>
</html>
