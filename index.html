<script>
async function getBalance(walletAddress) {
    try {
        console.log(`Fetching balance for wallet address: ${walletAddress}`);
        const apiEndpoint = "https://toncenter.com/api/v2/getAddressInformation";
        const response = await fetch(`${apiEndpoint}?address=${walletAddress}&api_key=a6bc56466ebb8b52e20b5714e3c08634600bc33300e77a4f98e77a59a7336eaf`);
        if (!response.ok) {
            throw new Error(`Error fetching balance for ${walletAddress}: ${response.statusText}`);
        }
        const data = await response.json();
        console.log("API response for balance data:", data);

        const balanceInTON = parseFloat(data.result.balance) / 1000000000;
        return balanceInTON || 0;
    } catch (error) {
        console.error(`Error fetching balance for ${walletAddress}:`, error);
        return 0;
    }
}

async function checkTransactions(walletAddress, userId) {
    const apiKey = "a6bc56466ebb8b52e20b5714e3c08634600bc33300e77a4f98e77a59a7336eaf";
    const apiEndpoint = `https://toncenter.com/api/v2/getTransactions?address=${walletAddress}&api_key=${apiKey}`;

    console.log(`Checking transactions for wallet address: ${walletAddress}`);

    try {
        const response = await fetch(apiEndpoint, {
            method: 'GET',
            headers: {
                'X-API-Key': apiKey
            }
        });

        if (!response.ok) {
            console.error(`HTTP error! status: ${response.status}`);
            return;
        }

        const data = await response.json();
        console.log("Transaction data:", data);

        if (data.result && Array.isArray(data.result) && data.result.length > 0) {
            for (const transaction of data.result) {
                console.log("Checking transaction:", transaction);

                // Temporary alert for testing
                const amount = parseFloat(transaction.value) / 1000000000;
                alert(`Transaction received: ${amount} TON`);

                // Uncomment the following condition after confirming transaction retrieval:
                // if (transaction.in_msg && transaction.in_msg.value.includes(userId)) {
                //     alert(`You have successfully participated with ${amount} TON`);
                //     break;
                // }
            }
        } else {
            console.log("No transactions found.");
        }
    } catch (error) {
        console.error("Error fetching transactions:", error);
    }
}

// Start checking for transactions at the defined interval
const walletAddress = "EQAF72soTe3EGsvWES2iDFYra3imEA9tixwrQ0VUyc4D7w04";
const userId = "229351215";
const checkInterval = 5000;

setInterval(() => {
    checkTransactions(walletAddress, userId);
}, checkInterval);
</script>
